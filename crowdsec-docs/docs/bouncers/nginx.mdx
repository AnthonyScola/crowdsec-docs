---
id: nginx
title: Nginx Bouncer
sidebar_position: 1
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import useBaseUrl from '@docusaurus/useBaseUrl';

<p align="center">
<img src={useBaseUrl('/img/crowdsec_nginx.svg')} alt="CrowdSec" title="CrowdSec" width="400" height="300" />
</p>
<p align="center">
<img src="https://img.shields.io/badge/build-pass-green" />
<img src="https://img.shields.io/badge/tests-pass-green" />
</p>
<p align="center">
&#x1F4DA; <a href="#installation/">Documentation</a>
&#x1F4A0; <a href="https://hub.crowdsec.net">Hub</a>
&#128172; <a href="https://discourse.crowdsec.net">Discourse </a>
</p>


A lua bouncer for nginx.

## How does it work ?

This bouncer leverages nginx lua's API, namely `access_by_lua_file` to check e IP address against the local API.

Supported features:

 - Live mode (query the local API for each request)
 - Stream mode (pull the local API in configured frequency)
 - Ban remediation (can ban an IP address by redirecting him or returning a custom HTML page)
 - reCaptcha v2 remediation (can return a captcha)
 - Support IP ranges (can apply a remediation on an IP range)

At the back, this bouncer uses [crowdsec lua lib](https://github.com/crowdsecurity/lua-cs-bouncer/).

## Installation

### Dependencies

Install the following packages:

```bash
sudo apt install nginx lua5.1 libnginx-mod-http-lua luarocks gettext-base
```

### Using packages

[Setup crowdsec repositories](/getting_started/install.mdx#install-our-repositories).

<Tabs
  defaultValue="debian"
  values={[
    { label: 'Debian/Ubuntu', value: 'debian' ,},
  ]
}>
<TabItem value="debian">

```bash
sudo apt install crowdsec-nginx-bouncer
```

</TabItem>

</Tabs>


### Manual installation

:::warning
nginx bouncer depends on nginx, lua5.1, libnginx-mod-http-lua, luarocks and gettext-base
it has been tested only on debian/ubuntu based distributions.
:::

Download the latest release [here](https://github.com/crowdsecurity/cs-nginx-bouncer/releases)

```bash
tar xvzf crowdsec-nginx-bouncer.tgz
cd crowdsec-nginx-bouncer-v*/
sudo ./install.sh
```

If you are on a mono-machine setup, the `crowdsec-nginx-bouncer` install script will register directly to the local crowdsec, so you're good to go !

:warning: the installation script will take care of dependencies for Debian/Ubuntu

<details>
  <summary>non-debian based dependencies</summary>

  - libnginx-mod-http-lua : nginx lua support
  - lua5.1: Lua
  - luarocks : Lua package manager
  - gettext-base: for the installation script

</details>


## Upgrade

### Manual Upgrade

If you already have `crowdsec-nginx-bouncer` installed, please download the [latest release](https://github.com/crowdsecurity/cs-nginx-bouncer/releases) and run the following commands:

```bash
tar xzvf crowdsec-nginx-bouncer.tgz
cd crowdsec-nginx-bouncer-v*/
sudo ./upgrade.sh
sudo systemctl restart nginx
```

## Configuration

### Example

```bash title="/etc/crowdsec/bouncers/crowdsec-nginx-bouncer.conf"
API_URL=<CROWDSEC_LAPI_URL>
API_KEY=<CROWDSEC_LAPI_KEY>
# bounce for all type of remediation that the bouncer can receive from the local API
BOUNCING_ON_TYPE=all
# when the bouncer receive an unknown remediation, fallback to this remediation
FALLBACK_REMEDIATION=ban
MODE=stream
REQUEST_TIMEOUT=1000
# exclude the bouncing on those location
EXCLUDE_LOCATION=
# Cache expiration in live mode, in second
CACHE_EXPIRATION=1
# Update frequency in stream mode, in second
UPDATE_FREQUENCY=10
#those apply for "ban" action
# /!\ REDIRECT_LOCATION and BAN_TEMPLATE_PATH/RET_CODE can't be used together. REDIRECT_LOCATION take priority over RET_CODE AND BAN_TEMPLATE_PATH
BAN_TEMPLATE_PATH=/var/lib/crowdsec/lua/templates/ban.html
REDIRECT_LOCATION=
RET_CODE=
#those apply for "captcha" action
# ReCaptcha Secret Key
SECRET_KEY=
# Recaptcha Site key
SITE_KEY=
CAPTCHA_TEMPLATE_PATH=/var/lib/crowdsec/lua/templates/captcha.html
CAPTCHA_EXPIRATION=3600
```

### Setup captcha
> Currently, on reCaptcha v2 is supported.

If you want to use reCaptcha with your Nginx Bouncer, you must provide a reCaptcha Site key and Secret key in your bouncer configuration.
Edit `etc/crowdsec/bouncers/crowdsec-nginx-bouncer.conf` and configure the following options:

```bash
SECRET_KEY=
SITE_KEY=
CAPTCHA_TEMPLATE_PATH=/var/lib/crowdsec/lua/templates/captcha.html
CAPTCHA_EXPIRATION=3600
```

Restart Nginx.

You can add a decisions with type captcha to check if the it works correctly:

```bash
sudo cscli decisions add -i <IP_TO_TEST> -t captcha
```

## FAQ

### Why remediation are not instantaneous

In stream mode, the bouncer will lunch the internal timer to pull the local API after the first request. After installing the bouncer, just do a simple curl on your website to trigger the puller timer.

### Resolver and certificates

In order to query `google.com` for the reCaptcha verification, we need to set a resolver and a SSL certificate in our nginx configuration.
Those are the default values, but you can change them:

```bash title="etc/nginx/conf.d/crowdsec_nginx.conf"
resolver 8.8.8.8 ipv6=off;
lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
```

And restart Nginx.
